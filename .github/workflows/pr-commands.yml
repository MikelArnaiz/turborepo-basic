# Generated by @catawiki/sdk-js

name: Commands

on:
  issue_comment:
    types: [created]

jobs:
  commands:
    if: |
      github.event.issue.pull_request &&
      (github.event.comment.body == '/publish')
    runs-on: ubuntu-latest
    name: Trigger command
    # env:
    #   GITHUB_TOKEN: ${{ c.GH_PAT }}
    #   NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    outputs:
      output1: ${{ steps.step1.outputs.test }}
    steps:
      - name: Step1
        id: step1
        run: echo "test=hello" >> "$GITHUB_OUTPUT"

      - name: Step2, echos step1 output
        id: step2
        run: echo ${{ steps.step1.outputs.test }}

      - name: Send a reaction to say we are working on it
        uses: dkershner6/reaction-action@v1
        with:
          token: ${{ secrets.GH_PAT }}
          reaction: 'eyes'

      - name: Fetch the last commit in the PR
        id: sha
        uses: actions/github-script@v4
        with:
          result-encoding: string
          script: |
            const { owner, repo, number } = context.issue;
            const pr = await github.pulls.get({
              owner,
              repo,
              pull_number: number,
            });
            return pr.data.head.sha

      - name: Show what commit hash we put in the mix
        run: echo Working on the commit hash ${{ steps.sha.outputs.result }}

      - name: Checkout the repository
        uses: actions/checkout@v2.3.4
        with:
          ref: ${{ steps.sha.outputs.result }}

      - name: Read NodeJS version from .nvmrc
        id: node-version
        uses: juliangruber/read-file-action@v1
        with:
          path: ./.nvmrc
          trim: true

      - name: Installs pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.6.2
          run_install: false

      - name: Setup NodeJS using the obtained nvm version
        uses: actions/setup-node@v3
        with:
          node-version: ${{ steps.node-version.outputs.content }}
          cache: 'pnpm'

      - name: Print pnpm version
        run: pnpm -v

      - name: Authenticate with GitHub NPM registry
        run: npm config set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}

      # - name: Authenticate with GitHub NPM registry
      #   run: |
      #     echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc

      - name: Restore cached node_modules
        uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/.nvmrc') }}-${{ hashFiles('**/yarn.lock') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Update versions
        if: github.event.comment.body == '/publish'
        run: pnpm changeset version --snapshot alpha && pnpm i --lockfile-only

      - name: Publish alpha version
        if: github.event.comment.body == '/publish'
        id: alphaversion
        # https://stackoverflow.com/q/65605228
        # run: |
        #   PUBLISHED_VERSIONS="$(pnpm changeset publish --tag alpha --no-git-tag --snapshot)"
        #   PUBLISHED_VERSIONS_TRIMMED=$(echo "$PUBLISHED_VERSIONS" | tail -n +4)
        #   echo "Published versions: $PUBLISHED_VERSIONS"
        #   echo "published_versions<<EOF" >> "$GITHUB_OUTPUT"
        #   echo "$PUBLISHED_VERSIONS_TRIMMED" >> "$GITHUB_OUTPUT"
        #   echo "EOF" >> "$GITHUB_OUTPUT"
        run: |
          PUBLISHED_VERSIONS="$(pnpm changeset publish --tag alpha --no-git-tag --snapshot 2>&1)"
          echo "published_versions<<EOF" >> "$GITHUB_OUTPUT"
          echo "$PUBLISHED_VERSIONS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      # - name: Echos alphaversion output
      #   if: github.event.comment.body == '/publish'
      #   run: |
      #     RESULT=$(echo "$steps.alphaversion.outputs.published_versions" | tail -n +4)
      #     echo "$RESULT"

      - name: Send a rocket so we know the comment is addressed
        uses: dkershner6/reaction-action@v1
        with:
          token: ${{ secrets.GH_PAT }}
          reaction: 'rocket'

      # - name: Put the package name into env so the next step can access it
      #   run: echo "NPM_PACKAGE_NAME=@${GITHUB_REPOSITORY//cw-/}" >> $GITHUB_ENV

      # - name: Remove first three lines
      #   run: echo "${{ steps.alphaversion.outputs.published_versions }}" | tail -n +4

      - name: Comment published version
        if: github.event.comment.body == '/publish'
        uses: winterjung/comment@v1.1.0
        with:
          type: create
          issue_number: ${{ github.event.issue.number }}
          token: ${{ secrets.GH_PAT }}
          body: |
            ```
            ${{ steps.alphaversion.outputs.published_versions }}
            ```

      # - name: Publish dev version - Success
      #   if: github.event.comment.body == '/publish'
      #   uses: winterjung/comment@v1.1.0
      #   with:
      #     type: create
      #     issue_number: ${{ github.event.issue.number }}
      #     token: ${{ secrets.GH_PAT }}
      #     body: |
      #       ### üöÄ The new dev version is released and ready to use:
      #       ```
      #       yarn add ${{ env.NPM_PACKAGE_NAME }}@0.0.0-${{ steps.sha.outputs.result }}
      #       ```

      #       ```
      #       pnpm add ${{ env.NPM_PACKAGE_NAME }}@0.0.0-${{ steps.sha.outputs.result }}
      #       ```
      #       #### happy hacking! ü•∑üèø
      #     GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Send a thumbs down when something went wrong
        if: ${{ failure() }}
        uses: dkershner6/reaction-action@v1
        with:
          token: ${{ secrets.GH_PAT }}
          reaction: '-1'
