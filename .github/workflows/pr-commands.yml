name: Commands

on:
  issue_comment:
    types: [created]

jobs:
  commands:
    if: |
      github.event.issue.pull_request &&
      (github.event.comment.body == '/publish') &&
      (github.event.pull_request.title != 'Version Packages')
    runs-on: ubuntu-latest
    name: Trigger command
    steps:
      - name: Send a reaction to say we are working on it
        uses: dkershner6/reaction-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Token automatically added by Github
          reaction: 'eyes'

      - name: Fetch the last commit in the PR
        id: sha
        uses: actions/github-script@v4
        with:
          result-encoding: string
          script: |
            const { owner, repo, number } = context.issue;
            const pr = await github.pulls.get({
              owner,
              repo,
              pull_number: number,
            });
            return pr.data.head.sha

      - name: Show what commit hash we put in the mix
        run: echo Working on the commit hash ${{ steps.sha.outputs.result }}

      - name: Checkout the repository
        uses: actions/checkout@v2.3.4
        with:
          ref: ${{ steps.sha.outputs.result }}

      - name: Read NodeJS version from .nvmrc
        id: node-version
        uses: juliangruber/read-file-action@v1
        with:
          path: ./.nvmrc
          trim: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.6.2
          run_install: false

      - name: Setup NodeJS using the obtained nvm version
        uses: actions/setup-node@v3
        with:
          node-version: ${{ steps.node-version.outputs.content }}
          cache: 'pnpm'

      - name: Print pnpm version
        run: pnpm -v

      - name: Authenticate with GitHub NPM registry
        run: npm config set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}

      - name: Restore cached node_modules
        uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/.nvmrc') }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Update versions
        # Alpha is the tag used, otherwise it will publish it as latest
        run: pnpm changeset version --snapshot alpha && pnpm i --lockfile-only

      - name: Build
        run: pnpm run build

      - name: Publish alpha version
        id: publish_alpha
        # Capturing STDERR with 2>&1, otherwise warn log lines are not logged
        run: |
          PUBLISHED_LOG="$(pnpm changeset publish --tag alpha --no-git-tag --snapshot 2>&1)"
          echo "published_log<<EOF" >> "$GITHUB_OUTPUT"
          echo "$PUBLISHED_LOG" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Token automatically added by Github
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Filter published log
        id: filter_published_log
        # Explanation,
        # grep -A selects 1000 lines after the string provided, 1000 is just a big number
        # sed '1d' removes the 1st line because grep -A is inclusive
        # finally removes the ðŸ¦‹ emoji for each line
        run: |
          published_log="${{ steps.publish_alpha.outputs.published_log }}"
          FILTERED_LOG=$(echo "$published_log" | grep -A 1000 "success packages published successfully:" | sed '1d' | grep -oP 'ðŸ¦‹  \K.*')
          echo "filtered_log<<EOF" >> "$GITHUB_OUTPUT"
          echo "$FILTERED_LOG" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create yarn command
        id: yarn_command
        run: |
          command="${{ steps.filter_published_log.outputs.filtered_log }}"
          YARN_ADD=$(echo "$command" | sed 's/^/yarn add /')
          echo "yarn_add<<EOF" >> "$GITHUB_OUTPUT"
          echo "$YARN_ADD" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create pnpm command
        id: pnpm_command
        run: |
          command="${{ steps.filter_published_log.outputs.filtered_log }}"
          PNPM_ADD=$(echo "$command" | sed 's/^/pnpm add /')
          echo "pnpm_add<<EOF" >> "$GITHUB_OUTPUT"
          echo "$PNPM_ADD" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Send a rocket so we know the comment is addressed
        uses: dkershner6/reaction-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Token automatically added by Github
          reaction: 'rocket'

      - name: Comment published version
        uses: winterjung/comment@v1.1.0
        with:
          type: create
          issue_number: ${{ github.event.issue.number }}
          token: ${{ secrets.GITHUB_TOKEN }} # Token automatically added by Github
          body: |
            ### ðŸš€ New alpha version released
            You can install it with yarn:
            ```
            ${{ steps.yarn_command.outputs.yarn_add }}
            ```

            or with pnpm:
            ```
            ${{ steps.pnpm_command.outputs.pnpm_add }}
            ```

            <details>
              <summary>Full log</summary>

              ```
              ${{ steps.publish_alpha.outputs.published_log }}
              ```
            </details>

      - name: Send a thumbs down when something went wrong
        if: ${{ failure() }}
        uses: dkershner6/reaction-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Token automatically added by Github
          reaction: '-1'
